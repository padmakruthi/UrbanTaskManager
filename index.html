<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Urban Task Manager</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      padding: 24px;
    }
    .app-container { max-width: 1100px; margin: 0 auto; }
    header { margin-bottom: 16px; }
    header h1 { font-size: 2rem; font-weight: 700; }
    .subtitle { margin-top: 4px; color: #9ca3af; font-size: 0.95rem; }

    /* Stats row */
    .stats-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .stat-card {
      flex: 1 1 150px;
      background: #020617;
      border-radius: 12px;
      padding: 10px 14px;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 30px rgba(15,23,42,0.6);
    }
    .stat-label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* Layout */
    main {
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 16px 40px rgba(15,23,42,0.8);
      border: 1px solid #1e293b;
    }
    .full-width { grid-column: 1 / -1; }
    .card h2 { font-size: 1.1rem; margin-bottom: 12px; }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .card-actions { display: flex; gap: 10px; }

    /* Form */
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    .form-group label span { color: #f97316; }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: 2px solid #2563eb;
      border-color: #2563eb;
    }
    .form-row { display: flex; gap: 10px; }

    /* Buttons */
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn.primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #e5e7eb;
    }
    .btn.secondary { background: #0f766e; color: #e5e7eb; }
    .btn.ghost {
      background: transparent;
      color: #9ca3af;
      border: 1px solid #334155;
    }
    .btn:hover { filter: brightness(1.1); }

    /* Table */
    .table-wrapper {
      max-height: 260px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #1e293b;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    thead {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #111827;
    }
    th { text-align: left; color: #9ca3af; font-weight: 500; }
    tbody tr:nth-child(even) { background: #020617; }

    /* Status pill */
    .status-pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
    }
    .status-pending { background: rgba(234,179,8,0.1); color: #eab308; }
    .status-assigned { background: rgba(34,197,94,0.1); color: #22c55e; }

    .message {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .message.error { color: #f97373; }
    .message.success { color: #22c55e; }

    @media (max-width: 800px) {
      main { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <h1>Urban Task Manager</h1>
      <p class="subtitle">Smart scheduling and live monitoring of city resources</p>
    </header>

    <!-- DASHBOARD STATS -->
    <section class="stats-row">
      <div class="stat-card">
        <div class="stat-label">Total Tasks</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Assigned Tasks</div>
        <div class="stat-value" id="stat-assigned">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending Tasks</div>
        <div class="stat-value" id="stat-pending">0</div>
      </div>
    </section>

    <main>
      <!-- LEFT: Add Task -->
      <section class="card">
        <h2>Add New Task</h2>
        <form id="task-form">
          <div class="form-group">
            <label for="title">Title<span>*</span></label>
            <input id="title" name="title" type="text" required placeholder="Pothole repair near main road" />
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3" placeholder="Short description of the issue"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="lat">Latitude<span>*</span></label>
              <input id="lat" name="lat" type="number" step="0.0001" required placeholder="17.4350" />
            </div>
            <div class="form-group">
              <label for="lon">Longitude<span>*</span></label>
              <input id="lon" name="lon" type="number" step="0.0001" required placeholder="78.4440" />
            </div>
          </div>

          <div class="form-group">
            <label for="urgency">Urgency (1â€“10)<span>*</span></label>
            <input id="urgency" name="urgency" type="number" min="1" max="10" required placeholder="10 = very urgent" />
          </div>

          <button type="submit" class="btn primary">Add Task & Auto-Schedule</button>
          <p id="form-message" class="message"></p>
        </form>
      </section>

      <!-- RIGHT: Tasks -->
      <section class="card">
        <div class="card-header">
          <h2>Tasks</h2>
          <div class="card-actions">
            <button id="refresh-tasks" class="btn ghost">Refresh</button>
            <button id="run-scheduler" class="btn secondary">Run Scheduler</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table id="tasks-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Urgency</th>
                <th>Status</th>
                <th>Assigned To</th>
                <th>ETA (min)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <p id="tasks-message" class="message"></p>
      </section>
    </main>

    <!-- RESOURCES -->
    <section class="card full-width">
      <div class="card-header">
        <h2>Resources</h2>
        <button id="refresh-resources" class="btn ghost">Load Resources</button>
      </div>
      <div class="table-wrapper">
        <table id="resources-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Current Load</th>
              <th>Capacity</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="resources-message" class="message"></p>
    </section>
  </div>

  <script>
    // IMPORTANT: using backend at 127.0.0.1:5000
    const API_BASE = "http://127.0.0.1:5000/api";

    // Stats
    const statTotal = document.getElementById("stat-total");
    const statAssigned = document.getElementById("stat-assigned");
    const statPending = document.getElementById("stat-pending");

    // Form & messages
    const taskForm = document.getElementById("task-form");
    const formMessage = document.getElementById("form-message");

    // Tasks
    const tasksTableBody = document.querySelector("#tasks-table tbody");
    const tasksMessage = document.getElementById("tasks-message");
    const refreshTasksBtn = document.getElementById("refresh-tasks");
    const runSchedulerBtn = document.getElementById("run-scheduler");

    // Resources
    const resourcesTableBody = document.querySelector("#resources-table tbody");
    const resourcesMessage = document.getElementById("resources-message");
    const refreshResourcesBtn = document.getElementById("refresh-resources");

    function setMessage(el, text, type = "") {
      el.textContent = text;
      el.className = "message";
      if (type) el.classList.add(type);
    }

    function createStatusPill(status) {
      const span = document.createElement("span");
      span.classList.add("status-pill");
      if (status === "assigned") span.classList.add("status-assigned");
      else span.classList.add("status-pending");
      span.textContent = status;
      return span;
    }

    // ---- METRICS ----
    async function loadMetrics() {
      try {
        const res = await fetch(`${API_BASE}/metrics`);
        if (!res.ok) throw new Error("metrics failed");
        const data = await res.json();
        statTotal.textContent = data.total_tasks;
        statAssigned.textContent = data.assigned_tasks;
        statPending.textContent = data.pending_tasks;
      } catch (err) {
        console.error(err);
      }
    }

    // ---- TASKS ----
    async function loadTasks() {
      try {
        setMessage(tasksMessage, "Loading tasks...");
        const res = await fetch(`${API_BASE}/tasks`);
        if (!res.ok) throw new Error("Failed to load tasks");
        const data = await res.json();

        tasksTableBody.innerHTML = "";
        if (data.length === 0) {
          setMessage(tasksMessage, "No tasks yet. Add one using the form.");
          return;
        }

        data.forEach(t => {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.textContent = t.id;

          const tdTitle = document.createElement("td");
          tdTitle.textContent = t.title;

          const tdUrgency = document.createElement("td");
          tdUrgency.textContent = t.urgency;

          const tdStatus = document.createElement("td");
          tdStatus.appendChild(createStatusPill(t.status));

          const tdRes = document.createElement("td");
          tdRes.textContent = t.resource || "-";

          const tdEta = document.createElement("td");
          tdEta.textContent = t.eta != null ? t.eta : "-";

          tr.appendChild(tdId);
          tr.appendChild(tdTitle);
          tr.appendChild(tdUrgency);
          tr.appendChild(tdStatus);
          tr.appendChild(tdRes);
          tr.appendChild(tdEta);

          tasksTableBody.appendChild(tr);
        });

        setMessage(tasksMessage, `Loaded ${data.length} task(s).`, "success");
      } catch (err) {
        console.error(err);
        setMessage(tasksMessage, "Error loading tasks.", "error");
      }
    }

    // ---- RESOURCES ----
    async function loadResources() {
      try {
        setMessage(resourcesMessage, "Loading resources...");
        const res = await fetch(`${API_BASE}/resources`);
        if (!res.ok) throw new Error("Failed to load resources");
        const data = await res.json();

        resourcesTableBody.innerHTML = "";
        if (data.length === 0) {
          setMessage(resourcesMessage, "No resources seeded.", "error");
          return;
        }

        data.forEach(r => {
          const tr = document.createElement("tr");

          const tdId = document.createElement("td");
          tdId.textContent = r.id;

          const tdName = document.createElement("td");
          tdName.textContent = r.name;

          const tdLoad = document.createElement("td");
          tdLoad.textContent = `${r.current_load}/${r.capacity}`;

          const tdCap = document.createElement("td");
          tdCap.textContent = r.capacity;

          tr.appendChild(tdId);
          tr.appendChild(tdName);
          tr.appendChild(tdLoad);
          tr.appendChild(tdCap);

          resourcesTableBody.appendChild(tr);
        });

        setMessage(resourcesMessage, `Loaded ${data.length} resource(s).`, "success");
      } catch (err) {
        console.error(err);
        setMessage(resourcesMessage, "Error loading resources.", "error");
      }
    }

    // ---- ADD TASK ----
    taskForm.addEventListener("submit", async e => {
      e.preventDefault();
      setMessage(formMessage, "Adding task & running scheduler...");

      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const lat = document.getElementById("lat").value;
      const lon = document.getElementById("lon").value;
      const urgency = document.getElementById("urgency").value;

      const payload = {
        title,
        description,
        lat: parseFloat(lat),
        lon: parseFloat(lon),
        urgency: parseInt(urgency, 10),
      };

      try {
        const res = await fetch(`${API_BASE}/add_task`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("Failed to add task");
        const data = await res.json();

        setMessage(formMessage, data.msg || "Task added!", "success");
        taskForm.reset();
        await Promise.all([loadTasks(), loadResources(), loadMetrics()]);
      } catch (err) {
        console.error(err);
        setMessage(formMessage, "Error adding task.", "error");
      }
    });

    // ---- RUN SCHEDULER ----
    runSchedulerBtn.addEventListener("click", async () => {
      setMessage(tasksMessage, "Running scheduler...");
      try {
        const res = await fetch(`${API_BASE}/schedule`, { method: "POST" });
        if (!res.ok) throw new Error("Scheduler failed");
        const data = await res.json();
        setMessage(
          tasksMessage,
          `Scheduler assigned ${data.count} task(s).`,
          "success"
        );
        await Promise.all([loadTasks(), loadResources(), loadMetrics()]);
      } catch (err) {
        console.error(err);
        setMessage(tasksMessage, "Error running scheduler.", "error");
      }
    });

    // Refresh buttons
    refreshTasksBtn.addEventListener("click", () => {
      loadTasks();
      loadMetrics();
    });
    refreshResourcesBtn.addEventListener("click", loadResources);

    // Initial load
    loadTasks();
    loadResources();
    loadMetrics();
  </script>
</body>
</html>
